From: Mykola Golub <mgolub@mirantis.com>
Date: Mon, 4 Jul 2016 13:54:32 +0300
Subject: librbd: prevent creation of clone from non-primary mirrored image

Fixes: http://tracker.ceph.com/issues/16449
Signed-off-by: Mykola Golub <mgolub@mirantis.com>
(cherry picked from commit ba849e3b04a5c513849d40a7fe4151375265302a)

Resolves: rhbz#1349332
---
 src/librbd/internal.cc | 15 +++++++++++++++
 1 file changed, 15 insertions(+)

diff --git a/src/librbd/internal.cc b/src/librbd/internal.cc
index fa97171..b1e23e0 100644
--- a/src/librbd/internal.cc
+++ b/src/librbd/internal.cc
@@ -1480,6 +1480,21 @@ int mirror_image_disable_internal(ImageCtx *ictx, bool force,
       return -EINVAL;
     }
 
+    if ((p_features & RBD_FEATURE_JOURNALING) != 0) {
+      bool force_non_primary = !non_primary_global_image_id.empty();
+      bool is_primary;
+      int r = Journal<>::is_tag_owner(p_imctx, &is_primary);
+      if (r < 0) {
+	lderr(cct) << "failed to determine tag ownership: " << cpp_strerror(r)
+		   << dendl;
+	return r;
+      }
+      if (!is_primary && !force_non_primary) {
+	lderr(cct) << "parent is non-primary mirrored image" << dendl;
+	return -EINVAL;
+      }
+    }
+
     if (use_p_features) {
       c_opts.set(RBD_IMAGE_OPTION_FEATURES, p_features);
     }
