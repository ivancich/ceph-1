From: Jason Dillaman <dillaman@redhat.com>
Date: Thu, 11 Aug 2016 19:09:09 -0400
Subject: librbd: block RPC requests when demoting the image

Signed-off-by: Jason Dillaman <dillaman@redhat.com>
(cherry picked from commit 8b195e1fc8fe70a0e5417934302d5831b1f8dfb3)

Resolves: rhbz#1349955
---
 src/librbd/internal.cc | 9 +++++++++
 1 file changed, 9 insertions(+)

diff --git a/src/librbd/internal.cc b/src/librbd/internal.cc
index b1e23e0..3392c09 100644
--- a/src/librbd/internal.cc
+++ b/src/librbd/internal.cc
@@ -2960,6 +2960,15 @@ int mirror_image_disable_internal(ImageCtx *ictx, bool force,
       return -EINVAL;
     }
 
+    // avoid accepting new requests from peers while we demote
+    // the image
+    ictx->exclusive_lock->block_requests(0);
+    BOOST_SCOPE_EXIT_ALL( (ictx) ) {
+      if (ictx->exclusive_lock != nullptr) {
+        ictx->exclusive_lock->unblock_requests();
+      }
+    };
+
     C_SaferCond lock_ctx;
     ictx->exclusive_lock->request_lock(&lock_ctx);
 
