From: Zhang Shaowen <zhangshaowen@cmss.chinamobile.com>
Date: Tue, 10 Jan 2017 16:36:13 +0800
Subject: rgw: bucket index check in radosgw-admin removes valid index.

Signed-off-by: Zhang Shaowen <zhangshaowen@cmss.chinamobile.com>
(cherry picked from commit a786252ed9c0e1ba08a88a43902f7aa1e91c10cd)
Signed-off-by: Pavan Rallabhandi <PRallabhandi@walmartlabs.com>

Conflicts:
	src/rgw/rgw_bucket.cc
		Jewel has RGWObjEnt, honor the same while populating obj oid

(cherry picked from commit ff67388e24c93ca16553839c16f51030fa322917)

Resolves: rhbz#1479949
---
 src/rgw/rgw_bucket.cc | 5 +++--
 1 file changed, 3 insertions(+), 2 deletions(-)

diff --git a/src/rgw/rgw_bucket.cc b/src/rgw/rgw_bucket.cc
index 8678a0c..1f5d1b0 100644
--- a/src/rgw/rgw_bucket.cc
+++ b/src/rgw/rgw_bucket.cc
@@ -1016,8 +1016,8 @@ int RGWBucket::check_bad_index_multipart(RGWBucketAdminOpState& op_state,
   int max = 1000;
 
   map<string, bool> common_prefixes;
-  string ns = "";
 
+  string ns = "multipart";
   bool is_truncated;
   map<string, bool> meta_objs;
   map<rgw_obj_key, string> all_objs;
@@ -1034,6 +1034,7 @@ int RGWBucket::check_bad_index_multipart(RGWBucketAdminOpState& op_state,
   RGWRados::Bucket::List list_op(&target);
 
   list_op.params.list_versions = true;
+  list_op.params.ns = ns;
 
   do {
     vector<RGWObjEnt> result;
@@ -2132,7 +2133,7 @@ public:
       return ret;
 
     /*
-     * We're unlinking the bucket but we don't want to update the entrypoint here â€” we're removing
+     * We're unlinking the bucket but we don't want to update the entrypoint here - we're removing
      * it immediately and don't want to invalidate our cached objv_version or the bucket obj removal
      * will incorrectly fail.
      */
