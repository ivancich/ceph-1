From: Casey Bodley <cbodley@redhat.com>
Date: Tue, 16 Aug 2016 16:58:51 -0400
Subject: rgw: RGWDataSyncCR fails on errors from RGWListBucketIndexesCR

Fixes: http://tracker.ceph.com/issues/17073

Signed-off-by: Casey Bodley <cbodley@redhat.com>
(cherry picked from commit e77a523f1d74768f4fef58c05cc167705d219036)

Resolves: rhbz#1368583
---
 src/rgw/rgw_data_sync.cc | 4 ++++
 1 file changed, 4 insertions(+)

diff --git a/src/rgw/rgw_data_sync.cc b/src/rgw/rgw_data_sync.cc
index bedfa06..101ddb0 100644
--- a/src/rgw/rgw_data_sync.cc
+++ b/src/rgw/rgw_data_sync.cc
@@ -1386,6 +1386,10 @@ public:
         /* state: building full sync maps */
         ldout(sync_env->cct, 20) << __func__ << "(): building full sync maps" << dendl;
         yield call(new RGWListBucketIndexesCR(sync_env, &sync_status));
+        if (retcode < 0) {
+          ldout(sync_env->cct, 0) << "ERROR: failed to build full sync maps, retcode=" << retcode << dendl;
+          return set_cr_error(retcode);
+        }
         sync_status.sync_info.state = rgw_data_sync_info::StateSync;
 
         /* update new state */
