From: Yehuda Sadeh <yehuda@redhat.com>
Date: Sat, 24 Sep 2016 10:46:36 -0700
Subject: rgw_admin: reshard also links to new bucket instance

Signed-off-by: Yehuda Sadeh <yehuda@redhat.com>
Signed-off-by: Daniel Gryniewicz <dang@redhat.com>
(cherry picked from commit 696e3747df582370e26947d8398de69240e96320)

Resolves: rhbz#1380601
---
 src/rgw/rgw_admin.cc | 9 +++++++++
 1 file changed, 9 insertions(+)

diff --git a/src/rgw/rgw_admin.cc b/src/rgw/rgw_admin.cc
index aa76fd2..9376974 100644
--- a/src/rgw/rgw_admin.cc
+++ b/src/rgw/rgw_admin.cc
@@ -4754,6 +4754,15 @@ next:
       }
       delete target_shards[i];
     }
+
+    bucket_op.set_bucket_id(new_bucket_info.bucket.bucket_id);
+    bucket_op.set_user_id(new_bucket_info.owner);
+    string err;
+    int r = RGWBucketAdminOp::link(store, bucket_op, &err);
+    if (r < 0) {
+      cerr << "failed to link new bucket instance (bucket_id=" << new_bucket_info.bucket.bucket_id << ": " << err << "; " << cpp_strerror(-r) << std::endl;
+      return -r;
+    }
   }
 
   if (opt_cmd == OPT_OBJECT_UNLINK) {
