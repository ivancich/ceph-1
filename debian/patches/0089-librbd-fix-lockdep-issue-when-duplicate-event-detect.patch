From: Jason Dillaman <dillaman@redhat.com>
Date: Mon, 20 Jun 2016 10:32:04 -0400
Subject: librbd: fix lockdep issue when duplicate event detected

Fixes: http://tracker.ceph.com/issues/16363
Signed-off-by: Jason Dillaman <dillaman@redhat.com>
(cherry picked from commit 86ef725c34ae950c0e41e89c1aa0c6a15e40f369)

Resolves: rhbz#1356064
---
 src/librbd/journal/Replay.cc | 5 ++++-
 1 file changed, 4 insertions(+), 1 deletion(-)

diff --git a/src/librbd/journal/Replay.cc b/src/librbd/journal/Replay.cc
index 93ef491..7d16685 100644
--- a/src/librbd/journal/Replay.cc
+++ b/src/librbd/journal/Replay.cc
@@ -723,8 +723,11 @@ Context *Replay<I>::create_op_context_callback(uint64_t op_tid,
   assert(m_lock.is_locked());
   if (m_op_events.count(op_tid) != 0) {
     lderr(cct) << "duplicate op tid detected: " << op_tid << dendl;
+
+    // on_ready is already async but on failure invoke on_safe async
+    // as well
     on_ready->complete(0);
-    on_safe->complete(-EINVAL);
+    m_image_ctx.op_work_queue->queue(on_safe, -EINVAL);
     return nullptr;
   }
 
