From: Jason Dillaman <dillaman@redhat.com>
Date: Sat, 17 Sep 2016 08:29:15 -0400
Subject: librbd: corrected use-after-free in ImageWatcher

Fixes: http://tracker.ceph.com/issues/17289
Signed-off-by: Jason Dillaman <dillaman@redhat.com>
(cherry picked from commit 2f4d4868e3b721c932c35ae7e8f0dd96b36a37fc)

Resolves: rhbz#1377777
---
 src/librbd/ImageWatcher.cc | 3 ++-
 1 file changed, 2 insertions(+), 1 deletion(-)

diff --git a/src/librbd/ImageWatcher.cc b/src/librbd/ImageWatcher.cc
index c828163..38083b4 100644
--- a/src/librbd/ImageWatcher.cc
+++ b/src/librbd/ImageWatcher.cc
@@ -61,9 +61,10 @@ struct C_UnwatchAndFlush : public Context {
     // to completing the callback to avoid racing an explicit
     // librados shutdown
     Context *ctx = on_finish;
+    r = ret_val;
     delete this;
 
-    ctx->complete(ret_val);
+    ctx->complete(r);
   }
 
   virtual void finish(int r) override {
