From: Orit Wasserman <owasserm@redhat.com>
Date: Fri, 8 Jul 2016 10:41:59 +0200
Subject: rgw: add missing master_zone when running with old default region
 config

Fixes: http://tracker.ceph.com/issues/16627

Signed-off-by: Orit Wasserman <owasserm@redhat.com>
(cherry picked from commit a0420741d446341a4979d78db7e2e58f396fdc4b)

Resolves: rhbz#1352888
---
 src/rgw/rgw_rados.cc | 11 +++++++++++
 1 file changed, 11 insertions(+)

diff --git a/src/rgw/rgw_rados.cc b/src/rgw/rgw_rados.cc
index 4262acf..2f2aee8 100644
--- a/src/rgw/rgw_rados.cc
+++ b/src/rgw/rgw_rados.cc
@@ -3353,6 +3353,17 @@ int RGWRados::replace_region_with_zonegroup()
       zoneparams.metadata_heap = ".rgw.meta";
       return zoneparams.update();
     }
+    /* update master zone */
+    RGWZoneGroup default_zg(default_zonegroup_name);
+    ret = default_zg.init(cct, this);
+    if (ret < 0 && ret != -ENOENT) {
+      ldout(cct, 0) << __func__ << ": error in initializing default zonegroup: " << cpp_strerror(-ret) << dendl;
+      return ret;
+    }
+    if (ret != -ENOENT && default_zg.master_zone.empty()) {
+      default_zg.master_zone = zoneparams.get_id();
+      return default_zg.update();
+    }
     return 0;
   }
 
